<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MusicSchool Colombia</title>
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Estilos globales: forzar recarga con versionado -->
  <link rel="stylesheet" href="/static/styles.css?v=4" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéµ</text></svg>">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header__inner">
      <div class="brand">
        <img class="brand__logo" alt="Logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 24 24'%3E%3Ctext y='18' x='2' font-size='18'%3E%F0%9F%8E%B5%3C/text%3E%3C/svg%3E"/>
        <span>MusicSchool Colombia</span>
      </div>
      <nav class="nav" role="navigation" aria-label="principal">
        <a class="active" href="/">Inicio</a>
        <a href="#cursos">Cursos</a>
        <a href="#contacto">Contacto</a>
        <!-- Acciones si NO autenticado -->
        <a id="btn-login-open" href="#">Ingresar</a>
        <a id="btn-register-open" href="#">Registrarse</a>
        <!-- Acciones si autenticado -->
        <span id="user-actions" class="hidden">
          <a id="btn-add-course-open" href="#">Agregar Curso</a>
          <a id="btn-logout" href="#">Salir</a>
          <span id="user-label" style="opacity:.8"></span>
        </span>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container hero__grid">
      <div>
        <h1>Aprende M√∫sica Online</h1>
        <p>Cursos profesionales de m√∫sica en l√≠nea, presenciales e h√≠bridos. Mejora tu t√©cnica con instructores expertos.</p>
        <div class="hero__cta">
          <a class="btn btn--primary" href="#cursos">Explorar Cursos</a>
        </div>
      </div>
      <div>
        <img alt="Ilustraci√≥n musical" loading="lazy" src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=1200&auto=format&fit=crop" style="border-radius: 18px; box-shadow: var(--shadow-lg);" />
      </div>
    </div>
  </section>

  <!-- Beneficios -->
  <section class="section">
    <div class="container">
      <div class="benefits">
        <article class="benefit">
          <h3>Instructores Expertos</h3>
          <p>Aprende de profesionales con experiencia comprobada en escenario y docencia.</p>
        </article>
        <article class="benefit">
          <h3>Modalidades Flexibles</h3>
          <p>Clases online, presenciales o h√≠bridas seg√∫n tu disponibilidad.</p>
        </article>
        <article class="benefit">
          <h3>Contenido de Calidad</h3>
          <p>Lecciones estructuradas, materiales descargables y soporte continuo.</p>
        </article>
      </div>
    </div>
  </section>

  <!-- Cursos Destacados -->
  <section id="cursos" class="section" aria-labelledby="cursos-title">
    <div class="container">
      <div class="courses__header">
        <h2 id="cursos-title" style="margin:0">Cursos Destacados</h2>
        <div>
          <select id="order" aria-label="Ordenar" style="padding:8px 12px; border-radius:10px; border:1px solid #e5eef7;">
            <option value="-created_at">Nuevos</option>
            <option value="-rating">Mejor calificados</option>
            <option value="price">Precio: menor a mayor</option>
            <option value="-price">Precio: mayor a menor</option>
          </select>
        </div>
      </div>
      <div id="courses-grid" class="courses__grid" aria-live="polite"></div>
      <div id="pagination" class="center" style="margin-top:16px"></div>
    </div>
  </section>

  <!-- Contacto -->
  <section id="contacto" class="section section-sm" aria-labelledby="contact-title">
    <div class="container">
      <h2 id="contact-title" class="center" style="margin-top:0">Contacto</h2>
      <div class="center" style="max-width:700px;margin:0 auto;">
        <p style="color:var(--text-500)">¬øTienes dudas o necesitas asesor√≠a? Escr√≠benos y te responderemos pronto.</p>
        <form id="contact-form" action="mailto:info@musicschool.co" method="post" enctype="text/plain" style="display:grid;gap:12px;margin-top:12px">
          <input type="text" name="name" placeholder="Tu nombre" required />
          <input type="email" name="email" placeholder="Tu email" required />
          <textarea name="message" placeholder="Tu mensaje" rows="4" style="padding:12px;border:1px solid #e5eef7;border-radius:10px" required></textarea>
          <div>
            <button class="btn btn--primary" type="submit">Enviar</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer__inner">
      <div>
        <h3 style="margin-top:0;color:#e2e8f0">MusicSchool Colombia</h3>
        <p style="margin:0;color:#94a3b8">Aprende con los mejores, a tu ritmo y desde cualquier lugar.</p>
      </div>
      <div>
        <h4 style="margin-top:0;color:#e2e8f0">Enlaces</h4>
        <ul style="list-style:none; padding:0; margin:0; color:#cbd5e1">
          <li><a href="#cursos">Cursos</a></li>
          <li><a href="#contacto">Contacto</a></li>
        </ul>
      </div>
      <div>
        <h4 style="margin-top:0;color:#e2e8f0">Contacto</h4>
        <p style="margin:0;color:#cbd5e1">info@musicschool.co</p>
      </div>
    </div>
    <div class="footer__bottom">
      ¬© <span id="year"></span> MusicSchool Colombia. Todos los derechos reservados.
    </div>
  </footer>

  <!-- Modales: Login, Registro, Agregar Curso -->
  <div id="modal-login" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <div class="modal">
      <h3 id="login-title">Ingresar</h3>
      <p>Accede con tu cuenta para gestionar tus cursos.</p>
      <form id="form-login">
        <input name="username" placeholder="Usuario" required />
        <input name="password" placeholder="Contrase√±a" type="password" required />
        <div class="actions">
          <button type="button" class="btn" data-close="#modal-login">Cancelar</button>
          <button class="btn btn--primary" type="submit">Ingresar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-register" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="register-title">
    <div class="modal">
      <h3 id="register-title">Registrarse</h3>
      <p>Crea tu cuenta como estudiante o instructor.</p>
      <form id="form-register">
        <input name="username" placeholder="Usuario" required />
        <input name="email" type="email" placeholder="Email" required />
        <input name="password" placeholder="Contrase√±a" type="password" required />
        <select name="role">
          <option value="student">Estudiante</option>
          <option value="instructor">Instructor</option>
        </select>
        <div class="actions">
          <button type="button" class="btn" data-close="#modal-register">Cancelar</button>
          <button class="btn btn--primary" type="submit">Crear cuenta</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-course" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="course-title">
    <div class="modal">
      <h3 id="course-title">Agregar Curso</h3>
      <p>Completa los campos para publicar tu curso.</p>
      <form id="form-course">
        <input name="title" placeholder="T√≠tulo" required />
        <textarea name="description" placeholder="Descripci√≥n" rows="3" style="padding:12px;border:1px solid #e5eef7;border-radius:10px" required></textarea>
        <div style="display:grid;gap:12px;grid-template-columns: repeat(2, minmax(0,1fr));">
          <select name="category" required>
            <option value="guitar">Guitarra</option>
            <option value="piano">Piano</option>
            <option value="violin">Viol√≠n</option>
            <option value="drums">Bater√≠a</option>
            <option value="singing">Canto</option>
            <option value="music_theory">Teor√≠a Musical</option>
          </select>
          <select name="course_type" required>
            <option value="online">En l√≠nea</option>
            <option value="presencial">Presencial</option>
            <option value="hibrido">H√≠brido</option>
          </select>
          <select name="level" required>
            <option value="beginner">Principiante</option>
            <option value="intermediate">Intermedio</option>
            <option value="advanced">Avanzado</option>
          </select>
          <input name="duration_weeks" type="number" min="1" step="1" placeholder="Semanas" required />
          <input name="total_lessons" type="number" min="1" step="1" placeholder="Total lecciones" required />
          <input name="price" type="number" min="0" step="0.01" placeholder="Precio (COP)" required />
          <input name="discount_percentage" type="number" min="0" max="100" step="1" placeholder="Descuento % (opcional)" />
        </div>
        <textarea name="schedule" placeholder="Horario (opcional)" rows="2" style="padding:12px;border:1px solid #e5eef7;border-radius:10px"></textarea>
        <div class="actions">
          <button type="button" class="btn" data-close="#modal-course">Cancelar</button>
          <button class="btn btn--primary" type="submit">Publicar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // A√±o din√°mico
    document.getElementById('year').textContent = new Date().getFullYear();

    const grid = document.getElementById('courses-grid');
    const selectOrder = document.getElementById('order');
    const pagination = document.getElementById('pagination');

    // Helpers de auth
    const TOKEN_KEY = 'ms_token';
    const USER_KEY = 'ms_user';

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function setToken(t) { t ? localStorage.setItem(TOKEN_KEY, t) : localStorage.removeItem(TOKEN_KEY); }
    function setUser(u) { u ? localStorage.setItem(USER_KEY, JSON.stringify(u)) : localStorage.removeItem(USER_KEY); }
    function getUser() { try { return JSON.parse(localStorage.getItem(USER_KEY)); } catch { return null; } }

    // UI Header auth
    const btnLoginOpen = document.getElementById('btn-login-open');
    const btnRegisterOpen = document.getElementById('btn-register-open');
    const userActions = document.getElementById('user-actions');
    const userLabel = document.getElementById('user-label');
    const btnLogout = document.getElementById('btn-logout');
    const btnAddCourseOpen = document.getElementById('btn-add-course-open');

    function updateHeaderUI() {
      const token = getToken();
      const user = getUser();
      const logged = !!token && !!user;
      btnLoginOpen.style.display = logged ? 'none' : '';
      btnRegisterOpen.style.display = logged ? 'none' : '';
      userActions.classList.toggle('hidden', !logged);
      if (logged) {
        userLabel.textContent = ' ' + (user.email || user.username || 'usuario');
        // Solo instructores pueden ver "Agregar Curso"
        btnAddCourseOpen.style.display = user.role === 'instructor' ? '' : 'none';
      }
    }

    // Modales utilidades
    function openModal(id) { document.querySelector(id).classList.add('show'); }
    function closeModal(id) { document.querySelector(id).classList.remove('show'); }
    document.querySelectorAll('[data-close]').forEach(el => {
      el.addEventListener('click', () => closeModal(el.getAttribute('data-close')));
    });

    btnLoginOpen.addEventListener('click', (e) => { e.preventDefault(); openModal('#modal-login'); });
    btnRegisterOpen.addEventListener('click', (e) => { e.preventDefault(); openModal('#modal-register'); });
    btnAddCourseOpen.addEventListener('click', (e) => { e.preventDefault(); openModal('#modal-course'); });

    btnLogout.addEventListener('click', async (e) => {
      e.preventDefault();
      const token = getToken();
      try {
        await fetch('/api/auth/logout/', { method: 'POST', headers: { 'Authorization': 'Token ' + token } });
      } catch {}
      setToken(null); setUser(null); updateHeaderUI();
    });

    // Formularios Auth
    const formLogin = document.getElementById('form-login');
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formLogin);
      const payload = { username: fd.get('username'), password: fd.get('password') };
      const res = await fetch('/api/auth/login/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) { alert('Credenciales inv√°lidas'); return; }
      const data = await res.json();
      setToken(data.token); setUser(data.user); updateHeaderUI(); closeModal('#modal-login');
      // recargar cursos por si hay nuevos del usuario
      loadCourses(selectOrder.value);
    });

    const formRegister = document.getElementById('form-register');
    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formRegister);
      const payload = { username: fd.get('username'), email: fd.get('email'), password: fd.get('password'), role: fd.get('role') };
      const res = await fetch('/api/auth/register/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) { const err = await res.json().catch(()=>({detail:'Error'})); alert(err.detail || 'Error'); return; }
      const data = await res.json();
      setToken(data.token); setUser(data.user); updateHeaderUI(); closeModal('#modal-register');
      loadCourses(selectOrder.value);
    });

    // Crear curso (solo instructores)
    const formCourse = document.getElementById('form-course');
    formCourse.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formCourse);
      const payload = {
        title: String(fd.get('title')||'').trim(),
        description: String(fd.get('description')||'').trim(),
        category: fd.get('category'),
        course_type: fd.get('course_type'),
        level: fd.get('level'),
        price: fd.get('price'),
        discount_percentage: fd.get('discount_percentage') || 0,
        duration_weeks: fd.get('duration_weeks'),
        total_lessons: fd.get('total_lessons'),
        schedule: fd.get('schedule') || ''
      };
      const token = getToken();
      const res = await fetch('/api/courses/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + token }, body: JSON.stringify(payload) });
      if (!res.ok) { const err = await res.json().catch(()=>({detail:'Error'})); alert(err.detail || 'Error'); return; }
      closeModal('#modal-course');
      formCourse.reset();
      // recargar listado (primera p√°gina, manteniendo orden actual)
      currentPage = 1;
      loadCourses(selectOrder.value, currentPage);
    });

    // Listado cursos + paginaci√≥n
    function formatPrice(num) {
      try { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(Number(num)); } catch { return num; }
    }

    function courseCard(course) {
      const hasDiscount = (course.discount_percentage || 0) > 0;
      const oldPrice = hasDiscount ? `<span class="old">${formatPrice(course.price)}</span>` : '';
      const discounted = hasDiscount ? Number(course.price) * (1 - Number(course.discount_percentage) / 100) : Number(course.price);
      const nowPrice = `<span class="now">${formatPrice(discounted)}</span>`;
      const thumb = course.thumbnail_url || 'https://images.unsplash.com/photo-1513885535751-8b9238bd3456?q=80&w=1200&auto=format&fit=crop';
      const instructor = course.instructor_name ? `<div class="meta"><span>üë®‚Äçüè´ ${course.instructor_name}</span></div>` : '';

      return `
        <article class="card" role="article">
          <div class="card__thumb">
            <img alt="${course.title}" src="${thumb}" loading="lazy" />
            ${hasDiscount ? `<div class="badge">-${course.discount_percentage}%</div>` : ''}
          </div>
          <div class="card__body">
            <h3 class="card__title">${course.title}</h3>
            ${instructor}
            <div class="meta">
              <span>‚è± ${course.duration_weeks || 0} semanas</span>
              <span>üéº ${course.level}</span>
              <span>‚≠ê ${course.rating || 5}</span>
            </div>
            <div class="price">${oldPrice}${nowPrice}</div>
          </div>
        </article>
      `;
    }

    let currentPage = 1;
    async function loadCourses(ordering = '-created_at', page = 1) {
      grid.innerHTML = '<div class="center" style="grid-column:1/-1;color:var(--text-500)">Cargando cursos‚Ä¶</div>';
      pagination.innerHTML = '';
      try {
        const url = `/api/courses/?ordering=${encodeURIComponent(ordering)}&page=${page}`;
        const res = await fetch(url);
        const data = await res.json();
        const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
        if (!Array.isArray(items) || items.length === 0) {
          grid.innerHTML = '<div class="center" style="grid-column:1/-1;color:var(--text-500)">No hay cursos disponibles por ahora.</div>';
        } else {
          grid.innerHTML = items.map(courseCard).join('');
        }
        // Paginaci√≥n simple si existe next/previous
        if (data && typeof data === 'object' && ('next' in data || 'previous' in data)) {
          const prevBtn = `<button class="btn" ${data.previous ? '' : 'disabled'} id="btn-prev">Anterior</button>`;
          const nextBtn = `<button class="btn" ${data.next ? '' : 'disabled'} id="btn-next">Siguiente</button>`;
          pagination.innerHTML = `${prevBtn} <span style="margin:0 8px;opacity:.7">P√°gina ${page}</span> ${nextBtn}`;
          const prev = document.getElementById('btn-prev');
          const next = document.getElementById('btn-next');
          prev && prev.addEventListener('click', () => { if (data.previous) { currentPage = Math.max(1, page - 1); loadCourses(ordering, currentPage); } });
          next && next.addEventListener('click', () => { if (data.next) { currentPage = page + 1; loadCourses(ordering, currentPage); } });
        }
      } catch (e) {
        grid.innerHTML = '<div class="center" style="grid-column:1/-1;color:crimson">Error cargando cursos.</div>';
      }
    }

    selectOrder.addEventListener('change', (e) => { currentPage = 1; loadCourses(e.target.value, currentPage); });

    // Hidratar estado de usuario si hay token
    (async function initAuth() {
      const token = getToken();
      if (token) {
        try {
          const res = await fetch('/api/auth/me/', { headers: { 'Authorization': 'Token ' + token } });
          if (res.ok) { const data = await res.json(); setUser(data.user); } else { setToken(null); setUser(null); }
        } catch { setToken(null); setUser(null); }
      }
      updateHeaderUI();
    })();

    // Cargar cursos inicio
    loadCourses(selectOrder.value, currentPage);
  </script>
</body>
</html>
